---
import DefaultLayout from '../layouts/default.astro';
import Today from '../components/Today.vue';
import EventList from '../components/EventList.vue';
import FilterBar from '../components/FilterBar.vue';
import Filters from '../components/Filters.vue';
import MonthNav from '../components/MonthNav.vue';

// Disable prerendering to enable SSR
export const prerender = false;

---

<DefaultLayout>
  <Today client:load />
  <FilterBar client:only="vue" />
  <Filters client:only="vue" />
  <div class="d-flex">
    <div class="sidebar">
      <MonthNav client:load contentRegion='[role="region"]' />
    </div>
    <div role="region" aria-labelledby="upcoming-events-heading" class="py-l">
      <h1 id="upcoming-events-heading" class="sr-only">Upcoming accessibility events</h1>
      <EventList type="upcoming" client:load />
    </div>
  </div>
  <!-- End container -->
</DefaultLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let drawer = document.querySelector('sl-drawer');
    let retries = 0;
    const maxRetries = 5;

    // If drawer not found, retry with delay
    function initDrawer() {
      if (!drawer && retries < maxRetries) {
        setTimeout(() => {
          drawer = document.querySelector('sl-drawer');
          if (drawer) {
            setupEventListeners();
          } else {
            retries++;
            initDrawer();
          }
        }, 100);
      } else if (drawer) {
        setupEventListeners();
      } else {
        console.error('Drawer not found after retries');
      }
    }

    function setupEventListeners() {
      document.addEventListener('filters:open', () => {
        try {
          drawer.show();
        } catch (e) {
          console.error('Error showing drawer:', e);
        }
      });

      document.addEventListener('filters:close', () => {
        try {
          drawer.hide();
        } catch (e) {
          console.error('Error hiding drawer:', e);
        }
      });
    }

    initDrawer();
  });
</script>

<style>
  .month-nav {
    position: sticky;
    top: 2rem;
  }

  .month-list {
    list-style: none;
    padding: 0;
  }

  .month-list a {
    display: block;
    padding: 0.5rem;
    color: inherit;
    text-decoration: none;
    width: 100%;
    text-align: left;
  }

  .month-list a:hover {
    text-decoration: underline;
  }

  .month-list a.active {
    font-weight: bold;
    color: var(--sl-color-primary-600);
  }
</style>
